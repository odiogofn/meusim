<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel de Consultas</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    nav { display: flex; background: #333; }
    nav button { flex: 1; padding: 15px; color: white; background: #333; border: none; cursor: pointer; }
    nav button.active { background: #555; }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; text-align: left; }
    .progress-container { width: 100%; background: #eee; margin-top: 15px; border-radius: 5px; }
    .progress-bar { width: 0%; height: 8px; background: #4caf50; border-radius: 5px; transition: width 1s ease; }
    .form-group { margin: 10px 0; }
  </style>
</head>
<body>
  <nav>
    <button id="btn-consulta" class="active">Consulta</button>
    <button id="btn-config">Configura√ß√£o</button>
  </nav>

  <!-- Aba Consulta -->
  <section id="consulta" class="active">
    <h2>Consulta de Dados</h2>
    <div class="form-group">
      <label>M√™s:</label>
      <input type="number" id="filtro-mes" min="1" max="12">
    </div>
    <div class="form-group">
      <label>Ano:</label>
      <input type="number" id="filtro-ano" min="2000" max="2100">
    </div>
    <div class="form-group">
      <label>Data de Entrega:</label>
      <input type="date" id="filtro-data">
    </div>
    <button onclick="consultar()">Consultar</button>
    <div class="progress-container"><div class="progress-bar" id="progress"></div></div>
    <table id="tabela-consulta">
      <thead>
        <tr>
          <th>M√™s</th>
          <th>Munic√≠pio</th>
          <th>Unidade Or√ßament√°ria</th>
          <th>Data de Entrega</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Aba Configura√ß√£o -->
  <section id="config">
    <h2>Configura√ß√£o de Clientes</h2>
    <table id="tabela-config">
      <thead>
        <tr>
          <th>Entidade</th>
          <th>Cod TCE</th>
          <th>Ativo</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <script>
    // üö® Coloque suas chaves aqui
    const SUPABASE_URL = "https://oxowmudtpuczbuzjpddf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94b3dtdWR0cHVjemJ1empwZGRmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1OTIzMzcxMSwiZXhwIjoyMDc0ODA5NzExfQ.-xBez5fx4Mk8BEzm2YE7QWs53nME07xUVDSlACha4uU"; 
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Alternar abas
    document.getElementById("btn-consulta").onclick = () => ativarAba("consulta");
    document.getElementById("btn-config").onclick = () => ativarAba("config");

    function ativarAba(aba) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.getElementById(aba).classList.add("active");
      if (aba === "consulta") document.getElementById("btn-consulta").classList.add("active");
      else document.getElementById("btn-config").classList.add("active");
      if (aba === "config") carregarConfig();
    }

    // Consulta
    async function consultar() {
      const mes = document.getElementById("filtro-mes").value;
      const ano = document.getElementById("filtro-ano").value;
      const data = document.getElementById("filtro-data").value;

      let query = supabase.from("consultas").select("mes, municipio, unidade_orcamentaria, data_entrega");

      if (mes) query = query.eq("mes", mes);
      if (ano) query = query.eq("ano", ano);
      if (data) query = query.eq("data_entrega", data);

      // filtrar s√≥ munic√≠pios ativos
      query = query.in("municipio", supabase.from("clientes").select("entidade").eq("ativo", "sim"));

      // Barra de progresso
      let progress = document.getElementById("progress");
      progress.style.width = "0%";
      setTimeout(() => progress.style.width = "70%", 100);

      let { data: resultados, error } = await query;
      progress.style.width = "100%";

      if (error) { alert("Erro: " + error.message); return; }

      let tbody = document.querySelector("#tabela-consulta tbody");
      tbody.innerHTML = "";
      resultados.forEach(r => {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.mes}</td><td>${r.municipio}</td><td>${r.unidade_orcamentaria}</td><td>${r.data_entrega}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Carregar clientes para configura√ß√£o
    async function carregarConfig() {
      let { data: clientes, error } = await supabase.from("clientes").select("entidade, cod_tce, ativo");
      if (error) { alert("Erro: " + error.message); return; }

      let tbody = document.querySelector("#tabela-config tbody");
      tbody.innerHTML = "";
      clientes.forEach(c => {
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.entidade}</td>
          <td>${c.cod_tce}</td>
          <td>${c.ativo}</td>
          <td>
            <button onclick="alterarAtivo('${c.cod_tce}','sim')">Ativar</button>
            <button onclick="alterarAtivo('${c.cod_tce}','nao')">Desativar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Alterar ativo
    async function alterarAtivo(cod, valor) {
      let { error } = await supabase.from("clientes").update({ ativo: valor }).eq("cod_tce", cod);
      if (error) alert("Erro: " + error.message);
      else carregarConfig();
    }
  </script>
</body>
</html>
