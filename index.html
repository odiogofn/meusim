<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta TCE</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav { margin-bottom: 20px; }
    nav button { margin-right: 10px; }
    .tab { display: none; }
    .tab.active { display: block; }
    textarea { width: 100%; height: 200px; margin-top: 10px; }
    select, button { margin: 5px 0; padding: 5px; }
  </style>
</head>
<body>
  <h1>üìä Consulta TCE - Cear√°</h1>
  <nav>
    <button onclick="openTab('consulta')">Consulta</button>
    <button onclick="openTab('configuracao')">Configura√ß√£o</button>
  </nav>

  <!-- Aba Consulta -->
  <div id="consulta" class="tab active">
    <h2>Consulta</h2>

    <label for="ano">Ano:</label>
    <select id="ano"></select>

    <label for="mes">M√™s:</label>
    <select id="mes">
      <option value="">Todos</option>
      <option value="Janeiro">Janeiro</option>
      <option value="Fevereiro">Fevereiro</option>
      <option value="Mar√ßo">Mar√ßo</option>
      <option value="Abril">Abril</option>
      <option value="Maio">Maio</option>
      <option value="Junho">Junho</option>
      <option value="Julho">Julho</option>
      <option value="Agosto">Agosto</option>
      <option value="Setembro">Setembro</option>
      <option value="Outubro">Outubro</option>
      <option value="Novembro">Novembro</option>
      <option value="Dezembro">Dezembro</option>
    </select>

    <br><br>
    <button onclick="extrair()">Extrair</button>
    <textarea id="status" readonly></textarea>
  </div>

  <!-- Aba Configura√ß√£o -->
  <div id="configuracao" class="tab">
    <h2>Configura√ß√£o</h2>
    <p>Lista de munic√≠pios ativos (setar <b>sim</b> ou <b>n√£o</b>):</p>
    <div id="config-container">Carregando...</div>
  </div>

  <script>
    // ====== Abas ======
    function openTab(tabId) {
      document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
    }

    // ====== Dropdown de anos (2025 ‚Üí 2000) ======
    const anoSelect = document.getElementById("ano");
    for (let ano = 2025; ano >= 2000; ano--) {
      const opt = document.createElement("option");
      opt.value = ano;
      opt.textContent = ano;
      anoSelect.appendChild(opt);
    }

    // ====== Extra√ß√£o SSE ======
    async function extrair() {
      const ano = document.getElementById("ano").value;
      const statusDiv = document.getElementById("status");
      statusDiv.value = "";

      const evtSource = new EventSource(`/api/extrair?ano=${ano}`);

      evtSource.onmessage = (event) => {
        if (event.data === "FIM") {
          evtSource.close();
        } else {
          statusDiv.value += event.data + "\n";
          statusDiv.scrollTop = statusDiv.scrollHeight;
        }
      };

      evtSource.onerror = (err) => {
        statusDiv.value += "‚ùå Erro na conex√£o com o servidor\n";
        evtSource.close();
      };
    }

    // ====== Carregar Configura√ß√£o (municipios ativos) ======
    async function carregarConfiguracao() {
      const container = document.getElementById("config-container");
      try {
        const res = await fetch("/api/clientes");
        if (!res.ok) throw new Error("Erro ao carregar configura√ß√£o");
        const clientes = await res.json();

        container.innerHTML = "";
        clientes.forEach(c => {
          const row = document.createElement("div");
          row.innerHTML = `
            <label>
              ${c.entidade} (${c.cod_tce}) 
              <select onchange="atualizarCliente('${c.cod_tce}', this.value)">
                <option value="sim" ${c.ativo === "sim" ? "selected" : ""}>sim</option>
                <option value="nao" ${c.ativo === "nao" ? "selected" : ""}>n√£o</option>
              </select>
            </label>
          `;
          container.appendChild(row);
        });
      } catch (err) {
        container.innerHTML = "‚ùå Erro ao carregar configura√ß√£o";
      }
    }

    // ====== Atualizar cliente (setar ativo = sim ou nao) ======
    async function atualizarCliente(cod_tce, ativo) {
      try {
        const res = await fetch("/api/clientes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cod_tce, ativo })
        });
        if (!res.ok) throw new Error("Erro ao atualizar");
      } catch (err) {
        alert("Erro ao atualizar cliente");
      }
    }

    // Carregar configura√ß√£o ao abrir a aba
    document.querySelector("button[onclick=\"openTab('configuracao')\"]")
      .addEventListener("click", carregarConfiguracao);
  </script>
</body>
</html>
