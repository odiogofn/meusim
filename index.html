<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Consulta TCE</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tabs { display: flex; margin-bottom: 10px; cursor: pointer; }
    .tab { padding: 10px 20px; border: 1px solid #ccc; }
    .tab.active { background: #eee; font-weight: bold; }
    .content { display: none; }
    .content.active { display: block; }
    .progress-container { width: 100%; background: #f3f3f3; border-radius: 5px; overflow: hidden; margin: 15px 0; }
    .progress-bar { width: 0; height: 20px; background: #4caf50; transition: width 0.5s ease; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Consulta TCE</h1>

  <!-- Abas -->
  <div class="tabs">
    <div class="tab active" onclick="openTab('consulta')">Consulta</div>
    <div class="tab" onclick="openTab('config')">Configuração</div>
  </div>

  <!-- Conteúdo da aba Consulta -->
  <div id="consulta" class="content active">
    <form id="consultaForm">
      <label>Ano:
        <select id="anoexc">
          <script>
            // gera anos 2025 -> 2000
            for (let y = 2025; y >= 2000; y--) {
              document.write(`<option value="${y}">${y}</option>`);
            }
          </script>
        </select>
      </label>

      <label>Mês:
        <select id="mes">
          <option value="">Todos</option>
          <option>Janeiro</option>
          <option>Fevereiro</option>
          <option>Março</option>
          <option>Abril</option>
          <option>Maio</option>
          <option>Junho</option>
          <option>Julho</option>
          <option>Agosto</option>
          <option>Setembro</option>
          <option>Outubro</option>
          <option>Novembro</option>
          <option>Dezembro</option>
        </select>
      </label>

      <button type="button" onclick="extrair()">Extração</button>
      <button type="button" onclick="salvarExtracao()">Salvar Extração</button>
      <button type="button" onclick="verUltimaExtracao()">Visualizar Última Extração</button>
    </form>

    <!-- Barra de progresso -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Resultados -->
    <table id="resultado">
      <thead>
        <tr>
          <th>Mês</th>
          <th>Data Limite</th>
          <th>Data Entrega</th>
          <th>Situação</th>
          <th>Unidade Orçamentária</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Conteúdo da aba Configuração -->
  <div id="config" class="content">
    <h3>Configuração de Municípios</h3>
    <table id="clientes">
      <thead>
        <tr><th>Município</th><th>Ativo</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Supabase init
    const supabaseUrl = "https://YOUR_PROJECT.supabase.co";
    const supabaseKey = "YOUR_SUPABASE_KEY";
    const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

    // Abas
    function openTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      document.querySelector(`.tab[onclick="openTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    // Progress bar animada
    function animateProgress() {
      const bar = document.getElementById("progressBar");
      bar.style.width = "0%";
      let width = 0;
      const interval = setInterval(() => {
        if (width >= 100) {
          clearInterval(interval);
        } else {
          width += 5;
          bar.style.width = width + "%";
        }
      }, 100);
    }

    // Extração
    let ultimaExtracao = [];

    async function extrair() {
      animateProgress();

      const { data, error } = await supabase
        .from("clientes")
        .select("*")
        .eq("ativo", "sim");

      if (error) { alert("Erro clientes: " + error.message); return; }

      const ano = document.getElementById("anoexc").value;

      ultimaExtracao = [];

      for (const cli of data) {
        try {
          const resp = await fetch(`/api/extracao?cod_tce=${cli.cod_tce}&ano=${ano}`);
          const json = await resp.json();
          if (json.html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(json.html, "text/html");
            const linhas = [...doc.querySelectorAll("#example tbody tr")];
            linhas.forEach(tr => {
              const cols = tr.querySelectorAll("td");
              if (cols.length) {
                ultimaExtracao.push({
                  municipio: cli.nome,
                  mes: cols[0].innerText.trim(),
                  data_limite: cols[1].innerText.trim(),
                  data_entrega: cols[2].innerText.trim(),
                  situacao: cols[3].innerText.trim(),
                  unidade: cols[4].innerText.trim(),
                  ano
                });
              }
            });
          }
        } catch (err) {
          console.error("Erro extracao:", err);
        }
      }

      renderTabela(ultimaExtracao);
    }

    function renderTabela(dados) {
      const tbody = document.querySelector("#resultado tbody");
      tbody.innerHTML = "";
      dados.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.mes}</td>
                        <td>${row.data_limite}</td>
                        <td>${row.data_entrega}</td>
                        <td>${row.situacao}</td>
                        <td>${row.unidade}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Salvar no Supabase
    async function salvarExtracao() {
      if (!ultimaExtracao.length) { alert("Nenhuma extração disponível"); return; }
      const { error } = await supabase.from("consultas").insert(ultimaExtracao);
      if (error) alert("Erro salvar: " + error.message);
      else alert("Extração salva com sucesso!");
    }

    // Visualizar última do banco
    async function verUltimaExtracao() {
      const { data, error } = await supabase
        .from("consultas")
        .select("*")
        .order("id", { ascending: false })
        .limit(50);
      if (error) { alert("Erro ver: " + error.message); return; }
      renderTabela(data);
    }

    // Carrega clientes na aba Configuração
    async function carregarClientes() {
      const { data, error } = await supabase.from("clientes").select("*");
      if (error) return;
      const tbody = document.querySelector("#clientes tbody");
      tbody.innerHTML = "";
      data.forEach(cli => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${cli.nome}</td>
                        <td>
                          <select onchange="atualizarCliente(${cli.id}, this.value)">
                            <option value="sim" ${cli.ativo==="sim"?"selected":""}>Sim</option>
                            <option value="nao" ${cli.ativo==="nao"?"selected":""}>Não</option>
                          </select>
                        </td>`;
        tbody.appendChild(tr);
      });
    }

    async function atualizarCliente(id, ativo) {
      await supabase.from("clientes").update({ ativo }).eq("id", id);
    }

    carregarClientes();
  </script>
</body>
</html>
